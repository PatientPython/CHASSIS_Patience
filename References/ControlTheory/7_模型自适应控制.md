# 模型自适应控制器详解

这份文档介绍了一种**模型自适应控制器（Model Self-adaptive Controller）**，其核心目的是解决轮腿机器人在实际运行中因**打滑**、**受阻**等因素导致的运动偏差问题。

我们定义整体的自适应补偿力矩 $T_{adapt}$ 由两部分组成：
$$ T_{adapt} = T_{traction} + T_{stability} $$
其中 $T_{traction}$ 用于解决轮速与车身速度不匹配的问题（牵引力控制），$T_{stability}$ 用于在异常工况下维持车身航向的稳定（稳定性/偏航控制）。

## 1. 状态估计 (State Estimation)

为了计算车身与轮子的运动差异，我们首先需要准确估计车身的真实运动状态。

### 1.1 车身速度估计
我们将使用一个标准的离散线性卡尔曼滤波器。

**状态空间方程 (State-Space Equation)**:

基于上述定义，系统的离散线性状态空间方程描述如下：
$$
\begin{cases} 

x_{k+1} = F x_k + w_k \\

z_k = H x_k + v_k

\end{cases}
$$
展开为矩阵形式：
$$
\underbrace{\begin{bmatrix} v \\ a \end{bmatrix}_{k+1}}_{x_{k+1}} = \underbrace{\begin{bmatrix} 1 & \Delta t \\ 0 & 1 \end{bmatrix}}_{F} \underbrace{\begin{bmatrix} v \\ a \end{bmatrix}_k}_{x_k} + \underbrace{w_k}_{Q_{kf}}
$$
$$
\underbrace{\begin{bmatrix} v_{wheel} \\ a_{imu} \end{bmatrix}_k}_{z_k} = \underbrace{\begin{bmatrix} 1 & 0 \\ 0 & 1 \end{bmatrix}}_{H} \underbrace{\begin{bmatrix} v \\ a \end{bmatrix}_k}_{x_k} + \underbrace{v_k}_{R_{kf}}
$$

其中：
*   $w_k \sim N(0, Q_{kf})$：过程噪声（Process Noise），反映了匀加速模型与实际物理运动之间的偏差。
*   $v_k \sim N(0, R_{kf})$：观测噪声（Measurement Noise），由轮速计和 IMU 的传感器噪声决定。

**状态向量 ($x$)**:
$$ \hat{x}_k = \begin{bmatrix} v_k \\ a_k \end{bmatrix} $$

*   $v_k$: 底盘速度
*   $a_k$: 底盘加速度（系统估计出的真实加速度，几乎等于直接IMU值）

**状态转移矩阵 ($F/A$) - 预测模型**:
基于匀加速模型 $v = v_0 + at, a = a_0$：
$$ F = \begin{bmatrix} 1 & \Delta t \\ 0 & 1 \end{bmatrix} $$

**观测向量 ($z$)**:
我们需要融合两个传感器：
$$ z_k = \begin{bmatrix} v_{body\_obs} \\ a_{imu} \end{bmatrix} $$

*   $v_{body\_obs}$: 基于轮子速度解算出的车身速度（对应状态 $v$）
*   $a_{imu}$: IMU测得的X轴加速度（对应状态 $a$）

**观测矩阵 ($H$)**:
因为传感器直接测量状态量：
$$ H = \begin{bmatrix} 1 & 0 \\ 0 & 1 \end{bmatrix} $$

### 1.2 偏航角速度估计

机器人绕Z轴的旋转角速度（Yaw Rate）不需要复杂的卡尔曼融合，直接使用陀螺仪读出的当前滤波后的角速度即可：
$$ \hat{\dot{\phi}} = \dot{\phi}_{gyro} $$

## 2. 牵引力控制项推导 ($T_{traction}$)

$T_{traction}$ 旨在消除轮子实际速度与基于车身速度计算出的“理想速度”之间的偏差，实现抓地力管理或差速脱困。（正常状态也加这个，但是把K调的小一点）

### 2.1 理想轮速计算
根据估计出的车身速度 $\hat{v}$ (即 $\hat{\dot{s}}$) 和偏航角速度 $\hat{\dot{\phi}}$，我们可以基于运动学计算出在无滑移情况下的理想轮速：

$$
\hat{\dot{\theta}}_{w,l} = \frac{1}{R_w}(\hat{\dot{s}}+ \dot{x_{c,L}} - R_l \hat{\dot{\phi}})
$$
$$
\hat{\dot{\theta}}_{w,r} = \frac{1}{R_w}(\hat{\dot{s}}+ \dot{x_{c,R}} + R_l \hat{\dot{\phi}})
$$

*   $\hat{\dot{\theta}}_{w,l}, \hat{\dot{\theta}}_{w,r}$：理想无滑移左/右轮角速度。
*   $R_w$：轮子半径； $R_l$：半轮距。

$$\dot{x_c}$$：C点x坐标的微分，向前为正
$$
E_{HM1} = (\hat{\dot{s}} + \dot{x_{c,L}} - R_l\hat{\dot{\phi}}) - \dot\theta_{w,l}R_w
$$

$$
E_{HM2} = (\hat{\dot{s}} + \dot{x_{c,R}} + R_l\hat{\dot{\phi}}) - \dot\theta_{w,r}R_w
$$

### 2.2 牵引力矩计算
牵引力矩与轮速误差成正比，作为一个基础的速度修正项：

$$
T_{traction,l} = \frac{K}{R_w}(\hat{\dot{\theta}}_{w,l} - \dot{\theta}_{w,l}) = K_{traction} \cdot E_{HM1}
$$

$$
T_{traction,r} = \frac{K}{R_w}(\hat{\dot{\theta}}_{w,r} - \dot{\theta}_{w,r}) = K_{traction} \cdot E_{HM2}
$$

当轮子打滑（实测 > 理想）时，输出负力矩对抗空转；当轮子受阻（实测 < 理想）时，输出正力矩辅助驱动。

## 3. 稳定性控制项推导 ($T_{stability}$)

$T_{stability}$ 实际上是一个**动态权重的偏航控制器 (Adaptive Yaw Control)**。其核心思想是根据轮子的物理状态（打滑或受阻），动态调整左右轮参与航向调节的权重，确保在单侧失效时仍能保持车身指向稳定。

### 3.1 物理状态判别逻辑
为了统一处理打滑和受阻，我们定义轮速误差 $E_{HM}$（线速度维度）：

$$\dot{x_c}$$：C点x坐标的微分，向前为正
$$
E_{HM1} = (\hat{\dot{s}} + \dot{x_{c,L}} - R_l\hat{\dot{\phi}}) - \dot\theta_{w,l}R_w
$$

$$
E_{HM2} = (\hat{\dot{s}} + \dot{x_{c,R}} + R_l\hat{\dot{\phi}}) - \dot\theta_{w,r}R_w
$$

设定死区阈值 $\delta$ (例如 0.5 m/s) 和饱和阈值 $E_{sat}$，

判别逻辑如下：

*   **打滑 (Slip)**: $E_{HM} < -\delta$。轮子空转，应**减小**该轮的驱动/转向权重。
*   **受阻 (Block)**: $E_{HM} > +\delta$。轮子卡滞，应**增大**该轮的驱动/转向权重。
*   **正常 (Normal)**: $-\delta \le E_{HM} \le +\delta$。保持标准参数。

计算状态强度系数 $\lambda$ (归一化到 0~1):
$$ \lambda(E_{HM}) = \text{Clamp}\left( \frac{|E_{HM}| - \delta}{E_{HM,Sat} - \delta}, \ 0, \ 1 \right) $$

### 3.2 动态权重计算 (Gain Styling)
基于状态强度，计算左右轮的偏航执行权重 $W$。设定最大调节幅度 $\alpha$ (例如 0.6，这块看轮毂电机何时到饱和电流值来定 $\alpha$)：

对于车轮 $i \in \{L, R\}$：
$$
W_i = 1.0 - \alpha \cdot \text{IsSlip}(E_{HM,i}) \cdot \lambda(E_{HM,i}) + \alpha \cdot \text{IsBlock}(E_{HM,i}) \cdot \lambda(E_{HM,i})
$$

其中：
*   $\text{IsSlip}(E_{HM,i})$：当 $E_{HM,i} < -\delta$ 时为 1，否则为 0。
*   $\text{IsBlock}(E_{HM,i})$：当 $E_{HM,i} > \delta$ 时为 1，否则为 0。

### 3.3 稳定性力矩计算
首先计算原始的偏航力矩需求：
$$ T_{yaw\_req} = K_{stability}(\psi_{target} - \psi_{actual}) $$

然后施加动态权重，得到最终的稳定性力矩 $T_{stability}$：
$$ T_{stability, L} = - T_{yaw\_req} \cdot W_L $$
$$ T_{stability, R} = + T_{yaw\_req} \cdot W_R $$

## 4. 整体输出公式 (Final Integration)

最终，模型自适应控制器的总输出 $T_{adapt}$ 是牵引力修正项与稳定性修正项的叠加。

$$ T_{adapt} = T_{traction} + T_{stability} $$

左轮自适应力矩：
$$
T_{adapt, L} = \underbrace{K_{traction} \cdot E_{HM1}}_{T_{traction, L}} + \underbrace{(- W_L \cdot K_{stability}(\psi_{target} - \psi_{actual}))}_{T_{stability, L}}
$$

右轮自适应力矩：
$$
T_{adapt, R} = \underbrace{K_{traction} \cdot E_{HM2}}_{T_{traction, R}} + \underbrace{(+ W_R \cdot K_{stability}(\psi_{target} - \psi_{actual}))}_{T_{stability, R}}
$$
